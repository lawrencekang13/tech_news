name: Deploy to Vercel and RSS Fetch

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡RSSè·å–ä»»åŠ¡
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  deploy:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      # å¦‚æœä½ çš„ Next.js é¡¹ç›®åœ¨ä»“åº“æ ¹ç›®å½•ï¼Œå¹¶ä¸”åç«¯åœ¨ 'backend/' å­ç›®å½•ï¼Œ
      # é‚£ä¹ˆ `npm ci` é»˜è®¤ä¼šåœ¨ä»“åº“æ ¹ç›®å½•æ‰§è¡Œï¼Œå®‰è£… Next.js çš„ä¾èµ–ã€‚
      # å¦‚æœä½ çš„åç«¯ package.json æ˜¯ç‹¬ç«‹çš„ï¼ŒVercel åœ¨éƒ¨ç½²æ—¶ä¼šæ ¹æ® Root Directory æ™ºèƒ½å¤„ç†ã€‚
      run: npm ci

    - name: Build project
      run: npm run build
      # env:
        # æ­£ç¡®å¼•ç”¨ GitHub Secrets ä½œä¸ºç¯å¢ƒå˜é‡
        #MONGO_URI: ${{ secrets.MONGO_URI }}
        #REDIS_URL: ${{ secrets.REDIS_URL }}
        #REDIS_TOKEN: ${{ secrets.REDIS_TOKEN }}
        #NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
        #NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        #NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        #NEXT_PUBLIC_APP_NAME: ${{ secrets.NEXT_PUBLIC_APP_NAME }}
        #NEXT_PUBLIC_APP_VERSION: ${{ secrets.NEXT_PUBLIC_APP_VERSION }}
        #RSS_SOURCES: ${{ secrets.RSS_SOURCES }}
        #CACHE_TTL_NEWS_LIST: ${{ secrets.CACHE_TTL_NEWS_LIST }}
        #CACHE_TTL_NEWS_DETAIL: ${{ secrets.CACHE_TTL_NEWS_DETAIL }}
        #CACHE_TTL_TRENDING: ${{ secrets.CACHE_TTL_TRENDING }}
        #NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        #NEWS_API_BASE_URL: ${{ secrets.NEWS_API_BASE_URL }}
        #NODE_ENV: production # éƒ¨ç½²æ—¶é€šå¸¸è®¾ç½®ä¸º production

    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        # æ­£ç¡®å¼•ç”¨ GitHub Secrets ä½œä¸º Vercel Action çš„è¾“å…¥å‚æ•°
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./next/ # å‡è®¾ä½ çš„ Next.js é¡¹ç›®åœ¨ä»“åº“æ ¹ç›®å½•ã€‚
                              # å¦‚æœä½ çš„ Next.js é¡¹ç›®åœ¨ 'frontend/' ç›®å½•ä¸‹ï¼Œè¯·æ”¹ä¸º './frontend/'
                              # åŒæ—¶ï¼Œç¡®ä¿ä½ çš„ Vercel é¡¹ç›®è®¾ç½®ä¸­çš„ "Root Directory" ä¹Ÿè®¾ç½®ä¸º 'frontend/'ã€‚

    # ğŸš€ æ–°å¢æˆ–ä¿®æ”¹ï¼šä½¿ç”¨ build-env æ¥ä¼ é€’æ‰€æœ‰ç¯å¢ƒå˜é‡
        build-env: |
          MONGO_URI=${{ secrets.MONGO_URI }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          REDIS_TOKEN=${{ secrets.REDIS_TOKEN }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          RSS_SOURCES=${{ secrets.RSS_SOURCES }}
          RSS_API_KEY=${{ secrets.RSS_API_KEY }}
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_NAME=${{ secrets.NEXT_PUBLIC_APP_NAME }}
          NEXT_PUBLIC_APP_VERSION=${{ secrets.NEXT_PUBLIC_APP_VERSION }}
          CACHE_TTL_NEWS_LIST=${{ secrets.CACHE_TTL_NEWS_LIST }}
          CACHE_TTL_NEWS_DETAIL=${{ secrets.CACHE_TTL_NEWS_DETAIL }}
          CACHE_TTL_TRENDING=${{ secrets.CACHE_TTL_TRENDING }}
          NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
          NEWS_API_BASE_URL=${{ secrets.NEWS_API_BASE_URL }}
          NODE_ENV=production

  rss-fetch:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
    - name: Fetch RSS Data
      run: |
        curl -X POST "${{ secrets.VERCEL_DEPLOYMENT_URL }}/api/rss/fetch" \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.RSS_API_KEY }}" \
          -d '{}'
      env:
        # VERCEL_DEPLOYMENT_URL é€šå¸¸ç”± Vercel Action åœ¨éƒ¨ç½²æˆåŠŸåè‡ªåŠ¨æä¾›
        # ç¡®ä¿ RSS_API_KEY å·²åœ¨ GitHub Secrets ä¸­å®šä¹‰
        VERCEL_DEPLOYMENT_URL: ${{ secrets.VERCEL_DEPLOYMENT_URL }}
        RSS_API_KEY: ${{ secrets.RSS_API_KEY }} # ç¡®ä¿è¿™ä¸ª Secret å­˜åœ¨ä¸”å€¼æ­£ç¡®
